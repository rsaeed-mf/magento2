<?php namespace MyFatoorah\Gateway\Library; use Exception; class  MyfatoorahApiV2{protected $apiURL='';private $apiKey;private $loggerObj;private $loggerFunc;public function __construct($apiKey,$countryMode='KWT',$isTest=false,$loggerObj=null,$loggerFunc=null){$mfCountries=$this->getMyFatoorahCountries();$code=strtoupper($countryMode);if(isset($mfCountries[$code])){$this->apiURL=($isTest)?$mfCountries[$code]['testv2']:$mfCountries[$code]['v2'];}$this->apiKey=trim($apiKey);$this->loggerObj=$loggerObj;$this->loggerFunc=$loggerFunc;}public function callAPI($url,$postFields=null,$orderId=null,$function=null){ini_set('precision',14);ini_set('serialize_precision',-1);$request=isset($postFields)?'POST':'GET';$fields=json_encode($postFields);$msgLog="Order #$orderId ----- $function";if($function!='Direct Payment'){$this->log("$msgLog - Request: $fields");}$curl=curl_init($url);curl_setopt_array($curl,array(CURLOPT_CUSTOMREQUEST=>$request,CURLOPT_POSTFIELDS=>$fields,CURLOPT_HTTPHEADER=>array("Authorization: Bearer $this->apiKey",'Content-Type: application/json'),CURLOPT_RETURNTRANSFER=>true,));$res=curl_exec($curl);$err=curl_error($curl);curl_close($curl);if($err){$this->log("$msgLog - cURL Error: $err");throw new Exception($err);}$this->log("$msgLog - Response: $res");$json=json_decode($res);$error=$this->{"getAPIError$request"}($json,$res);if($error){$this->log("$msgLog - Error: $error");throw new Exception($error);}return $json;}function getAPIErrorPOST($json,$res){if(isset($json->IsSuccess)&&$json->IsSuccess==true){return null;}if(isset($json->ValidationErrors)||isset($json->FieldsErrors)){$errorsObj=isset($json->ValidationErrors)?$json->ValidationErrors:$json->FieldsErrors;$blogDatas=array_column($errorsObj,'Error','Name');$err=implode(', ',array_map(function($k,$v){return"$k: $v";},array_keys($blogDatas),array_values($blogDatas)));}else if(isset($json->Data->ErrorMessage)){$err=$json->Data->ErrorMessage;}if(empty($err)){$err=(isset($json->Message))?$json->Message:(!empty($res)?$res:'Kindly, review your MyFatoorah admin configuration due to a wrong entry.');}return $err;}function getAPIErrorGET($json,$res){$stripHtmlStr=strip_tags($res);if($res!=$stripHtmlStr){return trim(preg_replace('/\s+/',' ',$stripHtmlStr));}if(!($json)||(isset($json->Message))){$message=isset($json->Message)?$json->Message:'';return $message.' Kindly, review your MyFatoorah admin configuration due to a wrong entry.';}return null;}public function getPhone($inputString){$newNumbers=range(0,9);$persianDecimal=array('&#1776;','&#1777;','&#1778;','&#1779;','&#1780;','&#1781;','&#1782;','&#1783;','&#1784;','&#1785;');$arabicDecimal=array('&#1632;','&#1633;','&#1634;','&#1635;','&#1636;','&#1637;','&#1638;','&#1639;','&#1640;','&#1641;');$arabic=array('٠','١','٢','٣','٤','٥','٦','٧','٨','٩');$persian=array('۰','۱','۲','۳','۴','۵','۶','۷','۸','۹');$string0=str_replace($persianDecimal,$newNumbers,$inputString);$string1=str_replace($arabicDecimal,$newNumbers,$string0);$string2=str_replace($arabic,$newNumbers,$string1);$string3=str_replace($persian,$newNumbers,$string2);$string4=preg_replace('/[^0-9]/','',$string3);if(strpos($string4,'00')===0){$string4=substr($string4,2);}if(!$string4){return['',''];}$len=strlen($string4);if($len<3||$len>14){throw new Exception('Phone Number lenght must be between 3 to 14 digits');}if(strlen(substr($string4,3))>3){return[substr($string4,0,3),substr($string4,3)];}else{return['',$string4];}}public function log($msg){if(!$this->loggerObj){return;}if(is_string($this->loggerObj)){error_log(PHP_EOL.date('d.m.Y h:i:s').' - '.$msg,3,$this->loggerObj);}else if(method_exists($this->loggerObj,$this->loggerFunc)){$this->loggerObj->{$this->loggerFunc}($msg);}}public function getWeightRate($unit){$unit1=strtolower($unit);if($unit1=='kg'){$rate=1;}else if($unit1=='g'){$rate=0.001;}else if($unit1=='lbs'||$unit1=='lb'){$rate=0.453592;}else if($unit1=='oz'){$rate=0.0283495;}else{throw new Exception('Weight must be in kg, g, lbs, or oz. Default is kg');}return $rate;}public function getDimensionRate($unit){$unit1=strtolower($unit);if($unit1=='cm'){$rate=1;}elseif($unit1=='m'){$rate=100;}else if($unit1=='mm'){$rate=0.1;}else if($unit1=='in'){$rate=2.54;}else if($unit1=='yd'){$rate=91.44;}else{throw new Exception('Dimension must be in cm, m, mm, in, or yd. Default is cm');}return $rate;}public function getCurrencyRate($currency){$json=$this->getCurrencyRates();foreach(($json)as $value){if($value->Text==$currency){return $value->Value;}}throw new Exception('The selected currency is not supported by MyFatoorah');}public function getCurrencyRates(){$url="$this->apiURL/v2/GetCurrenciesExchangeList";return $this->callAPI($url,null,null,'Get Currencies Exchange List');}function calcGatewayData($totalAmount,$currency,$paymentCurrencyIso,$allRatesData){foreach($allRatesData as $data){if($data->Text==$currency){$baseCurrencyRate=$data->Value;}if($data->Text==$paymentCurrencyIso){$gatewayCurrencyRate=$data->Value;}}if(isset($baseCurrencyRate)&&isset($gatewayCurrencyRate)){$baseAmount=ceil(((int)($totalAmount*1000))/$baseCurrencyRate/10)/100;return['GatewayTotalAmount'=>round(($baseAmount*$gatewayCurrencyRate),3),'GatewayCurrency'=>$paymentCurrencyIso];}else{return['GatewayTotalAmount'=>$totalAmount,'GatewayCurrency'=>$currency];}}function validateSignature($dataArray,$secret,$signature){uksort($dataArray,'strcasecmp');$output=implode(',',array_map(function($v,$k){return sprintf("%s=%s",$k,$v);},$dataArray,array_keys($dataArray)));$hash=base64_encode(hash_hmac('sha256',$output,$secret,true));if($signature===$hash){$this->log('valid signature');return true;}else{$this->log('Not a valid signature');die;}}public static function getMyFatoorahCountries(){$cachedFile=dirname(__FILE__).'/mf-config.json';if(file_exists($cachedFile)){if((time()-filemtime($cachedFile)>3600)){$countries=self::createNewMFConfigFile($cachedFile);}if(!empty($countries)){return $countries;}$cache=file_get_contents($cachedFile);return($cache)?json_decode($cache,true):[];}else{return self::createNewMFConfigFile($cachedFile);}}static function createNewMFConfigFile($cachedFile){$curl=curl_init('https://portal.myfatoorah.com/Files/API/mf-config.json');curl_setopt_array($curl,array(CURLOPT_HTTPHEADER=>array('Content-Type: application/json'),CURLOPT_RETURNTRANSFER=>true,));$response=curl_exec($curl);$http_code=curl_getinfo($curl,CURLINFO_HTTP_CODE);curl_close($curl);if($http_code==200){file_put_contents($cachedFile,$response);return json_decode($response,true);}return[];}}